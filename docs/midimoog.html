<!DOCTYPE html><html lang="en"><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><script>!function(){try{var d=document.documentElement.classList;d.remove('light','dark');var e=localStorage.getItem("theme");if(e){d.add(e)}else{d.add('light');}}catch(t){}}();</script><title>Loophole Letters</title><meta content="This is where felixroos writes about music and coding and stuff that he finds interesting." name="description"/><meta property="og:url" content="https://felixroos.github.io/midimoog"/><link rel="canonical" href="https://felixroos.github.io/midimoog"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous"/><meta property="og:type" content="website"/><meta property="og:site_name" content="Loophole Letters"/><meta property="og:description" content="This is where felixroos writes about music and coding and stuff that he finds interesting."/><meta property="og:title" content="Loophole Letters"/><meta property="og:image" content="https://felixroos.github.io/images/site-preview.png"/><meta name="next-head-count" content="13"/><link rel="preload" href="/_next/static/css/6e75c733fbeaed830339.css" as="style"/><link rel="stylesheet" href="/_next/static/css/6e75c733fbeaed830339.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-a54b4f32bdc1ef890ddd.js"></script><script src="/_next/static/chunks/webpack-ddd010a953737b6e3536.js" defer=""></script><script src="/_next/static/chunks/framework-895f067827ebe11ffe45.js" defer=""></script><script src="/_next/static/chunks/main-0a4e994bdc39ff189532.js" defer=""></script><script src="/_next/static/chunks/pages/_app-90a80ff1cc8d4db09709.js" defer=""></script><script src="/_next/static/chunks/763-f6d617bee32818d913b2.js" defer=""></script><script src="/_next/static/chunks/pages/%5Bslug%5D-f23579629df7f22d89c7.js" defer=""></script><script src="/_next/static/rm7EPdF-9_FvWqPzmBFFD/_buildManifest.js" defer=""></script><script src="/_next/static/rm7EPdF-9_FvWqPzmBFFD/_ssgManifest.js" defer=""></script></head><body><div id="__next"><header class="z-[1999] sticky top-0 bg-slate-900 dark:bg-slate-800 font-semibold p-2 text-white flex justify-center shadow-xl border-b border-gray-500 dark:border-gray-800"><div class="max-w-3xl w-full p-2 flex justify-between items-center"><h1 class="text-3xl"><a href="/">∞ loophole letters</a> </h1></div></header><div class="flex justify-center min-h-full dark:bg-slate-900 py-4"> <main class="max-w-3xl p-2"><article class="prose font-serif max-w-none  prose-headings:font-sans prose-headings:font-black prose-headings:text-slate-900  dark:prose-headings:text-gray-200  dark:text-gray-400 dark:prose-strong:text-gray-400 dark:prose-code:text-slate-400 dark:prose-a:text-gray-300 prose-a:text-slate-900 prose-blockquote:text-slate-800 dark:prose-blockquote:text-slate-400"><div class="border-b-4 border-dotted pb-2 border-slate-900 mb-4"><div class="md:flex justify-between"><h1 class="mb-4 ">Building a Minimoog MIDI Controller</h1><div class="flex space-x-2 items-start pb-4 md:pb-0"><div class="text-sm  bg-slate-200 dark:bg-slate-700 rounded-md p-2 font-serif text-slate-900 dark:text-white">diy</div><div class="text-sm  bg-slate-200 dark:bg-slate-700 rounded-md p-2 font-serif text-slate-900 dark:text-white">electronics</div><div class="text-sm  bg-slate-200 dark:bg-slate-700 rounded-md p-2 font-serif text-slate-900 dark:text-white">arduino</div></div></div><p class="italic p-0 m-0">June 11, 2020</p></div><div><p>Last week, a friend a I built a MIDI Controller for the Arturia Mini V3 VST:</p>
<p><img src="./img/miniv3.png" alt="mini v3"/></p>
<h2 id="front-panel-controls"><a aria-hidden="true" tabindex="-1" href="/midimoog#front-panel-controls"><span class="icon icon-link"></span></a>Front Panel Controls</h2>
<p>At first, we identified the different 44 controls we needed:</p>
<ul>
<li><a target="_blank" href="https://www.musikding.de/Alpha-Poti-16mm-gewinkelt-print-5k-lin">21 potentiometers</a> (with 2 <a target="_blank" href="https://www.musikding.de/Bakelit-Knopf-21mm-schwarz">21mm</a> and 19 <a target="_blank" href="https://www.musikding.de/Bakelit-Knopf-19mm-schwarz">19mm</a> bakelit knobs)</li>
<li><a target="_blank" href="https://www.musikding.de/Drehschalter-6-Pole-2-Stellungen-offen">6 rotary switches</a> (with <a target="_blank" href="https://www.musikding.de/Chickenhead-23mm-schwarz">chicken head knobs</a>)</li>
<li><a target="_blank" href="https://www.conrad.de/de/p/tru-components-tc-r13-2-05-kippschalter-250-v-ac-1-5-a-1-x-aus-ein-rastend-1-1587664.html">17 flip switches</a></li>
</ul>
<p>We decided to omit the following rather useless controls:</p>
<ul>
<li>A440 rocker switch</li>
<li>soft clipping switch + button</li>
<li>all keyboard controls</li>
<li>flip switch + overload leds</li>
</ul>
<p>Also, we decided to use flip switches only + we added 2 extra flip switches below the 3 pots on the left.</p>
<p>This is the front panel with all the pots and switches in place:</p>
<p><img src="./img/midimoogpanel.png" alt="front panel"/></p>
<p>for comparison:</p>
<p><img src="./img/miniv3frontpanel.png" alt="mini v3 front panel"/></p>
<h2 id="midi-brain"><a aria-hidden="true" tabindex="-1" href="/midimoog#midi-brain"><span class="icon icon-link"></span></a>MIDI Brain</h2>
<p>To read the positions of all controls, we ended up using the Arduino Micro:</p>
<p><img src="./img/arduinopins.png" alt="arduino pins"/></p>
<ul>
<li>it has a ATmega32U4 microcontroller, which makes it usable as a USB device</li>
<li>it has up to 12 analog inputs and up to 20 digital inputs</li>
</ul>
<h2 id="analog-input-multiplexing"><a aria-hidden="true" tabindex="-1" href="/midimoog#analog-input-multiplexing"><span class="icon icon-link"></span></a>Analog Input Multiplexing</h2>
<p>As we have 44 controls and only 12 analog inputs, we used seven <a target="_blank" href="https://www.musikding.de/CD4051">cd4051 ics</a>:</p>
<p><img src="./img/cd4051.png" alt="cd4051 pins"/></p>
<ul>
<li>pins 6 7 &amp; 8 can be connected to ground</li>
<li>pin 16 is connected to 5V</li>
<li>the &quot;channel in&quot; pins are connected to the controls</li>
<li>via the select pins a b and c, we can control which &quot;channel in&quot; is routed to the &quot;com out&quot;. This is done by splitting the three digits of a binary number (000-111) to the three select pins.<!-- -->
<ul>
<li>by constantly looping through all inputs, we can read all 8 controls in a short amount of time</li>
<li>this &quot;trick&quot; is also called time multiplexing, which makes the cd4051 a multiplexer</li>
</ul>
</li>
<li>so with the 12 analog inputs of the arduino, we can connect up to 12x8 = 96 controls</li>
</ul>
<h2 id="the-board"><a aria-hidden="true" tabindex="-1" href="/midimoog#the-board"><span class="icon icon-link"></span></a>The Board</h2>
<p>To connect all 44 controls with the multiplexers to the arduino, I drew this board plan:</p>
<p><img src="./img/boardplan1.png" alt="board plan 1"/></p>
<ul>
<li><a target="_blank" href="https://www.conrad.de/de/p/rademacher-wr-typ-710-5-platine-hartpapier-l-x-b-160-mm-x-100-mm-35-m-rastermass-2-54-mm-inhalt-1-529506.html">the copper strips</a> go from left to right</li>
<li>black boxes: <a href="(https:/www.musikding.de/CD4051)">cd4051 multiplexers</a></li>
<li>blue vertical lines: <a target="_blank" href="https://www.musikding.de/Platinen-Steckverbinder-8-polig">8 pole plug jacks</a></li>
<li>red: 5V</li>
<li>white: ground</li>
<li>shades of blue: select bits a b and c</li>
<li>red vertical marks: copper cuts</li>
<li>green: output cables</li>
</ul>
<p>By rotating the middle row of ics by 180 degrees, we can spare some cables for ground and the select pins.</p>
<p>After soldering it together, the board looked like this:</p>
<p><img src="./img/board1.png" alt="soldered board"/></p>
<h2 id="problems"><a aria-hidden="true" tabindex="-1" href="/midimoog#problems"><span class="icon icon-link"></span></a>Problems</h2>
<p>As this was our first real electronics project, we ran into some unforseen problems.</p>
<h3 id="problem-1-mirroring"><a aria-hidden="true" tabindex="-1" href="/midimoog#problem-1-mirroring"><span class="icon icon-link"></span></a>Problem 1: Mirroring</h3>
<ul>
<li>After the plan was made, we started using it on the copper side (top image) to solder the <a target="_blank" href="https://www.musikding.de/16-Pin-Sockel">16 pin jacks</a> and the <a target="_blank" href="https://www.musikding.de/Platinen-Steckverbinder-8-polig">plug jacks</a>.</li>
<li>When we were done soldering, we realized that if we now attach the ics from the plastic side (down image), they will be mirrored, having wrong pin placements!</li>
<li><strong>Workaround</strong>: To fix the problem, we painstakingly bent all the ic legs to the other side to &quot;mirror&quot; them...</li>
<li><strong>Future Learning</strong>: Use two plans, where one is the mirrored version of the other, for both sides of the board</li>
</ul>
<h3 id="problem-2-empty-inputs"><a aria-hidden="true" tabindex="-1" href="/midimoog#problem-2-empty-inputs"><span class="icon icon-link"></span></a>Problem 2: Empty Inputs</h3>
<ul>
<li>Another thing that we realized too late was all the multiplexers inputs must be connected to the circuit to make them work</li>
<li><strong>Workaround</strong>: We connected all empty inputs via 10k pull up resistors to ground</li>
<li><strong>Future Learning</strong>: It&#x27;s better to use up as much inputs as possible</li>
</ul>
<h2 id="wiring-the-controls"><a aria-hidden="true" tabindex="-1" href="/midimoog#wiring-the-controls"><span class="icon icon-link"></span></a>Wiring the controls</h2>
<p><img src="./img/panelwires.png" alt="panel wires"/></p>
<ul>
<li>the middle pins of each pot + one of the pins of each switch are connected to ic inputs</li>
<li>all other pins of the switches + one of the outer pot pins are connected to 5V</li>
<li>all remaining pins are connected to ground</li>
<li>all the 5V pins of the switches are connected to ground with a 10k resistor</li>
<li>we transformed the rotary switches to potentiometers <a target="_blank" href="https://www.instructables.com/id/Arduino-Rotary-Switch-One-Analogue-Input/">by connecting the outer pins via resistors</a></li>
</ul>
<p>For the switches and the empty inputs (see Problem 2), we added the resistors directly on the board, before the plugs:</p>
<p><img src="./img/boardwithresistors.png" alt="board with resistors"/></p>
<ul>
<li><strong>Future Learning</strong>: Add the resistors directly to the 5V pin</li>
</ul>
<h2 id="programming-the-arduino"><a aria-hidden="true" tabindex="-1" href="/midimoog#programming-the-arduino"><span class="icon icon-link"></span></a>Programming the Arduino</h2>
<p>The controls can be identified like this:</p>
<pre class="language-c"><code class="language-c"><span class="token keyword">const</span> <span class="token keyword">int</span> NControls <span class="token operator">=</span> <span class="token number">44</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> connected<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token number">184</span><span class="token punctuation">,</span> <span class="token comment">// polyphonic switch</span>
  <span class="token number">185</span><span class="token punctuation">,</span> <span class="token comment">// volume poti</span>
  <span class="token number">186</span><span class="token punctuation">,</span> <span class="token comment">// unison switch</span>
  <span class="token number">187</span><span class="token punctuation">,</span> <span class="token comment">// voice detune poti</span>
  <span class="token number">191</span><span class="token punctuation">,</span> <span class="token comment">// osc3 volume poti</span>
  <span class="token number">193</span><span class="token punctuation">,</span> <span class="token comment">// ext volume switch</span>
  <span class="token number">195</span><span class="token punctuation">,</span> <span class="token comment">// keyboard ctrl 1 switch</span>
  <span class="token number">196</span><span class="token punctuation">,</span> <span class="token comment">// amp attack poti</span>
  <span class="token number">197</span><span class="token punctuation">,</span> <span class="token comment">// filter mod switch</span>
  <span class="token number">198</span><span class="token punctuation">,</span> <span class="token comment">// osc1 switch</span>
  <span class="token number">201</span><span class="token punctuation">,</span> <span class="token comment">// osc2 tune poti</span>
  <span class="token number">203</span><span class="token punctuation">,</span> <span class="token comment">// osc1 range rotary switch</span>
  <span class="token number">204</span><span class="token punctuation">,</span> <span class="token comment">// noise volume poti</span>
  <span class="token number">205</span><span class="token punctuation">,</span> <span class="token comment">// osc2 switch</span>
  <span class="token number">206</span><span class="token punctuation">,</span> <span class="token comment">// osc3 switch</span>
  <span class="token number">207</span><span class="token punctuation">,</span> <span class="token comment">// noise switch</span>
  <span class="token number">208</span><span class="token punctuation">,</span> <span class="token comment">// osc2 range rotary switch</span>
  <span class="token number">211</span><span class="token punctuation">,</span> <span class="token comment">// vcf cutoff poti</span>
  <span class="token number">213</span><span class="token punctuation">,</span> <span class="token comment">// vcf decay poti</span>
  <span class="token number">214</span><span class="token punctuation">,</span> <span class="token comment">// osc2 vol poti</span>
  <span class="token number">215</span><span class="token punctuation">,</span> <span class="token comment">// osc1 vol poti</span>
  <span class="token number">216</span><span class="token punctuation">,</span> <span class="token comment">// osc2 waveform rotary switch</span>
  <span class="token number">217</span><span class="token punctuation">,</span> <span class="token comment">// osc3 waveform rotary switch</span>
  <span class="token number">218</span><span class="token punctuation">,</span> <span class="token comment">// vcf emphasis poti</span>
  <span class="token number">221</span><span class="token punctuation">,</span> <span class="token comment">// external volume poti</span>
  <span class="token number">223</span><span class="token punctuation">,</span> <span class="token comment">// keyboard ctrl 2 switch</span>
  <span class="token number">224</span><span class="token punctuation">,</span> <span class="token comment">// osc1 frequency sync switch</span>
  <span class="token number">225</span><span class="token punctuation">,</span> <span class="token comment">// osc3 tune poti</span>
  <span class="token number">226</span><span class="token punctuation">,</span> <span class="token comment">// osc1 waveform rotary switch</span>
  <span class="token number">227</span><span class="token punctuation">,</span> <span class="token comment">// osc3 range rotary switch</span>
  <span class="token number">228</span><span class="token punctuation">,</span> <span class="token comment">// white/pink switch</span>
  <span class="token number">231</span><span class="token punctuation">,</span> <span class="token comment">// effect 2 switch</span>
  <span class="token number">232</span><span class="token punctuation">,</span> <span class="token comment">// effect 1 switch</span>
  <span class="token number">233</span><span class="token punctuation">,</span> <span class="token comment">// osc2 ctrl switch</span>
  <span class="token number">234</span><span class="token punctuation">,</span> <span class="token comment">// master tune poti</span>
  <span class="token number">235</span><span class="token punctuation">,</span> <span class="token comment">// osc modulation switch</span>
  <span class="token number">236</span><span class="token punctuation">,</span> <span class="token comment">// glide poti</span>
  <span class="token number">237</span><span class="token punctuation">,</span> <span class="token comment">// mod mix poti</span>
  <span class="token number">238</span><span class="token punctuation">,</span> <span class="token comment">// osc3 ctrl switch</span>
  <span class="token number">274</span><span class="token punctuation">,</span> <span class="token comment">// vcf sustain poti</span>
  <span class="token number">276</span><span class="token punctuation">,</span> <span class="token comment">// vcf contour poti</span>
  <span class="token number">277</span><span class="token punctuation">,</span> <span class="token comment">// amp sustain poti</span>
  <span class="token number">275</span><span class="token punctuation">,</span> <span class="token comment">// amp decay poti</span>
  <span class="token number">194</span> <span class="token comment">// vcf attack poti</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<ul>
<li>The first two digits are the analog input of the ic (a0 - a5 = 18 - 23, a9 = 27)</li>
<li>The third digit is where the control is connected to the ic (1-8)</li>
</ul>
<p>For easier access, we can seperate the two numbers into two arrays:</p>
<pre class="language-c"><code class="language-c"><span class="token keyword">int</span> analogInput<span class="token punctuation">[</span>NControls<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// holds aX for every index</span>
<span class="token keyword">int</span> selectByte<span class="token punctuation">[</span>NControls<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// holds select byte for every index (controls ic)</span>
<span class="token keyword">void</span> <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span>byte i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NControls<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    analogInput<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">floor</span><span class="token punctuation">(</span>connected<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">/</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    selectByte<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> connected<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">%</span><span class="token number">10</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>In the loop function, we can now read all the voltages:</p>
<pre class="language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span>byte i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NControls<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// loop through all connected controls</span>
    <span class="token comment">// select correct byte for current control</span>
    <span class="token function">digitalWrite</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token function">bitRead</span><span class="token punctuation">(</span>selectByte<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">digitalWrite</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">,</span> <span class="token function">bitRead</span><span class="token punctuation">(</span>selectByte<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">digitalWrite</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token function">bitRead</span><span class="token punctuation">(</span>selectByte<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> voltage <span class="token operator">=</span> <span class="token function">analogRead</span><span class="token punctuation">(</span>analogInput<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 0-1023</span>
    <span class="token function">voltageToMidi</span><span class="token punctuation">(</span>voltage<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Now we can transform the raw voltage value to MIDI messages:</p>
<pre class="language-c"><code class="language-c"><span class="token keyword">int</span> midiCh <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> cc <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> voltageChangeThreshold <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> TIMEOUT <span class="token operator">=</span> <span class="token number">300</span><span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">long</span> PTime<span class="token punctuation">[</span>NControls<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// previous time the voltage changed (more than threshold)</span>
<span class="token keyword">int</span> midiPState<span class="token punctuation">[</span>NControls<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// previous sent midi value for control i</span>
<span class="token keyword">int</span> voltagePState<span class="token punctuation">[</span>NControls<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// voltage of control i at last midi send</span>

<span class="token keyword">void</span> <span class="token function">voltageToMidi</span><span class="token punctuation">(</span><span class="token keyword">int</span> voltage<span class="token punctuation">,</span> <span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">abs</span><span class="token punctuation">(</span>voltage<span class="token operator">-</span>voltagePState<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> voltageChangeThreshold<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    PTime<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">millis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">millis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> PTime<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> TIMEOUT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// here the voltage changed significantly and &quot;stayed there&quot; for more than 300 ms</span>
    <span class="token keyword">int</span> midiValue<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isInverted</span><span class="token punctuation">(</span>connected<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      midiValue <span class="token operator">=</span> <span class="token function">map</span><span class="token punctuation">(</span>voltage<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1023</span><span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// flipped last 2 numbers to invert</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>connected<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">227</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      midiValue <span class="token operator">=</span> <span class="token function">rotaryMidi</span><span class="token punctuation">(</span>voltage<span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      midiValue <span class="token operator">=</span> <span class="token function">map</span><span class="token punctuation">(</span>voltage<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1023</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// only send midi if it changes (0-127)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>midiPState<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> midiValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">controlChange</span><span class="token punctuation">(</span>midiCh<span class="token punctuation">,</span> cc<span class="token operator">+</span>i<span class="token punctuation">,</span> midiValue<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// send midi</span>
      MidiUSB<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// force send midi immediately</span>
      voltagePState<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> voltage<span class="token punctuation">;</span> <span class="token comment">// remember last voltage where midi was sent</span>
      midiPState<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> midiValue<span class="token punctuation">;</span> <span class="token comment">// update last sent midi</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<ul>
<li>to compensate for voltage jitter, we ignore voltage changes that are lower than a threshold of 8</li>
<li>if the voltage change is above the the theshold, the time is remembered</li>
<li>for 300ms after a significant voltage change, the voltage is mapped to a midi value (0-127)</li>
<li>if the calculated midi value is different from the last, the value is sent out, using <a target="_blank" href="https://www.arduino.cc/en/Reference/MIDIUSB">MIDIUSB lib</a></li>
<li>isInverted inverts the mapping for controls with inverted voltages (depends on wiring of 5v and ground)</li>
<li>rotaryMidi maps the 6 step rotary switch to the target 7 step midi value of osc3 range (ignoring the first step)</li>
</ul>
<a href="https://gist.github.com/felixroos/929a8d9c303748179c6bca835e6a16ab" target="_blank"><p>show complete code</p></a>
<h2 id="conclusion"><a aria-hidden="true" tabindex="-1" href="/midimoog#conclusion"><span class="icon icon-link"></span></a>Conclusion</h2>
<p>After 4 days of soldering, and learning a lot about electronics, the basic controller was finished. I also built a prototype case:</p>
<p><img src="./img/caseprototype.jpg" alt="case"/></p>
<p>Huge thanks goes out</p>
<ul>
<li><a target="_blank" href="https://goetzmd.de/category/diy/diy-midi-controller">!! Goetz Müller Dürholt for his DIY Midi Controller Series</a></li>
<li><a target="_blank" href="https://www.musiconerd.com/single-post/arduino-pro-micro-as-a-usb-midi-device">Gustavo Silveira for the mapping idea</a></li>
<li><a target="_blank" href="https://www.instructables.com/id/Arduino-Rotary-Switch-One-Analogue-Input/">Mr Fid for the rotary switch idea</a></li>
</ul>
<p>I already know that this was not the last MIDI controller to build for myself. Next time, I will try to build a controller for the Prophet V (maybe also including keys).</p>
<h3 id="tbd"><a aria-hidden="true" tabindex="-1" href="/midimoog#tbd"><span class="icon icon-link"></span></a>TBD</h3>
<ul>
<li>build proper case</li>
<li>add labels</li>
<li>minor midi mapping issues</li>
</ul></div></article></main></div><div class="py-4 font-serif bg-slate-900 dark:bg-slate-800 text-white flex justify-center items-center"><p class="leading-none"><a class="underline" href="https://github.com/felixroos">Felix Roos</a> <!-- -->2021</p></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"frontmatter":{"title":"Building a Minimoog MIDI Controller","date":"2020-06-11","tags":["diy","electronics","arduino"],"description":"Last week, a friend a I built a MIDI Controller for the Arturia Mini V3 VST.","image":"img/miniv3frontpanel.png"},"code":"var Component=(()=\u003e{var r=Object.create;var c=Object.defineProperty;var p=Object.getOwnPropertyDescriptor;var d=Object.getOwnPropertyNames;var h=Object.getPrototypeOf,m=Object.prototype.hasOwnProperty;var i=a=\u003ec(a,\"__esModule\",{value:!0});var u=(a,n)=\u003e()=\u003e(n||a((n={exports:{}}).exports,n),n.exports),k=(a,n)=\u003e{i(a);for(var s in n)c(a,s,{get:n[s],enumerable:!0})},N=(a,n,s)=\u003e{if(n\u0026\u0026typeof n==\"object\"||typeof n==\"function\")for(let t of d(n))!m.call(a,t)\u0026\u0026t!==\"default\"\u0026\u0026c(a,t,{get:()=\u003en[t],enumerable:!(s=p(n,t))||s.enumerable});return a},g=a=\u003eN(i(c(a!=null?r(h(a)):{},\"default\",a\u0026\u0026a.__esModule\u0026\u0026\"default\"in a?{get:()=\u003ea.default,enumerable:!0}:{value:a,enumerable:!0})),a);var o=u((I,l)=\u003e{l.exports=_jsx_runtime});var y={};k(y,{default:()=\u003ef,frontmatter:()=\u003ew});var e=g(o()),w={title:\"Building a Minimoog MIDI Controller\",date:\"2020-06-11\",tags:[\"diy\",\"electronics\",\"arduino\"],description:\"Last week, a friend a I built a MIDI Controller for the Arturia Mini V3 VST.\",image:\"img/miniv3frontpanel.png\"};function b(a){let n=Object.assign({p:\"p\",img:\"img\",h2:\"h2\",a:\"a\",span:\"span\",ul:\"ul\",li:\"li\",h3:\"h3\",strong:\"strong\",pre:\"pre\",code:\"code\"},a.components),{wrapper:s}=n,t=(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(n.p,{children:\"Last week, a friend a I built a MIDI Controller for the Arturia Mini V3 VST:\"}),`\n`,(0,e.jsx)(n.p,{children:(0,e.jsx)(n.img,{src:\"./img/miniv3.png\",alt:\"mini v3\"})}),`\n`,(0,e.jsxs)(n.h2,{id:\"front-panel-controls\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#front-panel-controls\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Front Panel Controls\"]}),`\n`,(0,e.jsx)(n.p,{children:\"At first, we identified the different 44 controls we needed:\"}),`\n`,(0,e.jsxs)(n.ul,{children:[`\n`,(0,e.jsxs)(n.li,{children:[(0,e.jsx)(n.a,{href:\"https://www.musikding.de/Alpha-Poti-16mm-gewinkelt-print-5k-lin\",children:\"21 potentiometers\"}),\" (with 2 \",(0,e.jsx)(n.a,{href:\"https://www.musikding.de/Bakelit-Knopf-21mm-schwarz\",children:\"21mm\"}),\" and 19 \",(0,e.jsx)(n.a,{href:\"https://www.musikding.de/Bakelit-Knopf-19mm-schwarz\",children:\"19mm\"}),\" bakelit knobs)\"]}),`\n`,(0,e.jsxs)(n.li,{children:[(0,e.jsx)(n.a,{href:\"https://www.musikding.de/Drehschalter-6-Pole-2-Stellungen-offen\",children:\"6 rotary switches\"}),\" (with \",(0,e.jsx)(n.a,{href:\"https://www.musikding.de/Chickenhead-23mm-schwarz\",children:\"chicken head knobs\"}),\")\"]}),`\n`,(0,e.jsx)(n.li,{children:(0,e.jsx)(n.a,{href:\"https://www.conrad.de/de/p/tru-components-tc-r13-2-05-kippschalter-250-v-ac-1-5-a-1-x-aus-ein-rastend-1-1587664.html\",children:\"17 flip switches\"})}),`\n`]}),`\n`,(0,e.jsx)(n.p,{children:\"We decided to omit the following rather useless controls:\"}),`\n`,(0,e.jsxs)(n.ul,{children:[`\n`,(0,e.jsx)(n.li,{children:\"A440 rocker switch\"}),`\n`,(0,e.jsx)(n.li,{children:\"soft clipping switch + button\"}),`\n`,(0,e.jsx)(n.li,{children:\"all keyboard controls\"}),`\n`,(0,e.jsx)(n.li,{children:\"flip switch + overload leds\"}),`\n`]}),`\n`,(0,e.jsx)(n.p,{children:\"Also, we decided to use flip switches only + we added 2 extra flip switches below the 3 pots on the left.\"}),`\n`,(0,e.jsx)(n.p,{children:\"This is the front panel with all the pots and switches in place:\"}),`\n`,(0,e.jsx)(n.p,{children:(0,e.jsx)(n.img,{src:\"./img/midimoogpanel.png\",alt:\"front panel\"})}),`\n`,(0,e.jsx)(n.p,{children:\"for comparison:\"}),`\n`,(0,e.jsx)(n.p,{children:(0,e.jsx)(n.img,{src:\"./img/miniv3frontpanel.png\",alt:\"mini v3 front panel\"})}),`\n`,(0,e.jsxs)(n.h2,{id:\"midi-brain\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#midi-brain\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"MIDI Brain\"]}),`\n`,(0,e.jsx)(n.p,{children:\"To read the positions of all controls, we ended up using the Arduino Micro:\"}),`\n`,(0,e.jsx)(n.p,{children:(0,e.jsx)(n.img,{src:\"./img/arduinopins.png\",alt:\"arduino pins\"})}),`\n`,(0,e.jsxs)(n.ul,{children:[`\n`,(0,e.jsx)(n.li,{children:\"it has a ATmega32U4 microcontroller, which makes it usable as a USB device\"}),`\n`,(0,e.jsx)(n.li,{children:\"it has up to 12 analog inputs and up to 20 digital inputs\"}),`\n`]}),`\n`,(0,e.jsxs)(n.h2,{id:\"analog-input-multiplexing\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#analog-input-multiplexing\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Analog Input Multiplexing\"]}),`\n`,(0,e.jsxs)(n.p,{children:[\"As we have 44 controls and only 12 analog inputs, we used seven \",(0,e.jsx)(n.a,{href:\"https://www.musikding.de/CD4051\",children:\"cd4051 ics\"}),\":\"]}),`\n`,(0,e.jsx)(n.p,{children:(0,e.jsx)(n.img,{src:\"./img/cd4051.png\",alt:\"cd4051 pins\"})}),`\n`,(0,e.jsxs)(n.ul,{children:[`\n`,(0,e.jsx)(n.li,{children:\"pins 6 7 \u0026 8 can be connected to ground\"}),`\n`,(0,e.jsx)(n.li,{children:\"pin 16 is connected to 5V\"}),`\n`,(0,e.jsx)(n.li,{children:'the \"channel in\" pins are connected to the controls'}),`\n`,(0,e.jsxs)(n.li,{children:['via the select pins a b and c, we can control which \"channel in\" is routed to the \"com out\". This is done by splitting the three digits of a binary number (000-111) to the three select pins.',`\n`,(0,e.jsxs)(n.ul,{children:[`\n`,(0,e.jsx)(n.li,{children:\"by constantly looping through all inputs, we can read all 8 controls in a short amount of time\"}),`\n`,(0,e.jsx)(n.li,{children:'this \"trick\" is also called time multiplexing, which makes the cd4051 a multiplexer'}),`\n`]}),`\n`]}),`\n`,(0,e.jsx)(n.li,{children:\"so with the 12 analog inputs of the arduino, we can connect up to 12x8 = 96 controls\"}),`\n`]}),`\n`,(0,e.jsxs)(n.h2,{id:\"the-board\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#the-board\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"The Board\"]}),`\n`,(0,e.jsx)(n.p,{children:\"To connect all 44 controls with the multiplexers to the arduino, I drew this board plan:\"}),`\n`,(0,e.jsx)(n.p,{children:(0,e.jsx)(n.img,{src:\"./img/boardplan1.png\",alt:\"board plan 1\"})}),`\n`,(0,e.jsxs)(n.ul,{children:[`\n`,(0,e.jsxs)(n.li,{children:[(0,e.jsx)(n.a,{href:\"https://www.conrad.de/de/p/rademacher-wr-typ-710-5-platine-hartpapier-l-x-b-160-mm-x-100-mm-35-m-rastermass-2-54-mm-inhalt-1-529506.html\",children:\"the copper strips\"}),\" go from left to right\"]}),`\n`,(0,e.jsxs)(n.li,{children:[\"black boxes: \",(0,e.jsx)(n.a,{href:\"(https://www.musikding.de/CD4051)\",children:\"cd4051 multiplexers\"})]}),`\n`,(0,e.jsxs)(n.li,{children:[\"blue vertical lines: \",(0,e.jsx)(n.a,{href:\"https://www.musikding.de/Platinen-Steckverbinder-8-polig\",children:\"8 pole plug jacks\"})]}),`\n`,(0,e.jsx)(n.li,{children:\"red: 5V\"}),`\n`,(0,e.jsx)(n.li,{children:\"white: ground\"}),`\n`,(0,e.jsx)(n.li,{children:\"shades of blue: select bits a b and c\"}),`\n`,(0,e.jsx)(n.li,{children:\"red vertical marks: copper cuts\"}),`\n`,(0,e.jsx)(n.li,{children:\"green: output cables\"}),`\n`]}),`\n`,(0,e.jsx)(n.p,{children:\"By rotating the middle row of ics by 180 degrees, we can spare some cables for ground and the select pins.\"}),`\n`,(0,e.jsx)(n.p,{children:\"After soldering it together, the board looked like this:\"}),`\n`,(0,e.jsx)(n.p,{children:(0,e.jsx)(n.img,{src:\"./img/board1.png\",alt:\"soldered board\"})}),`\n`,(0,e.jsxs)(n.h2,{id:\"problems\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#problems\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Problems\"]}),`\n`,(0,e.jsx)(n.p,{children:\"As this was our first real electronics project, we ran into some unforseen problems.\"}),`\n`,(0,e.jsxs)(n.h3,{id:\"problem-1-mirroring\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#problem-1-mirroring\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Problem 1: Mirroring\"]}),`\n`,(0,e.jsxs)(n.ul,{children:[`\n`,(0,e.jsxs)(n.li,{children:[\"After the plan was made, we started using it on the copper side (top image) to solder the \",(0,e.jsx)(n.a,{href:\"https://www.musikding.de/16-Pin-Sockel\",children:\"16 pin jacks\"}),\" and the \",(0,e.jsx)(n.a,{href:\"https://www.musikding.de/Platinen-Steckverbinder-8-polig\",children:\"plug jacks\"}),\".\"]}),`\n`,(0,e.jsx)(n.li,{children:\"When we were done soldering, we realized that if we now attach the ics from the plastic side (down image), they will be mirrored, having wrong pin placements!\"}),`\n`,(0,e.jsxs)(n.li,{children:[(0,e.jsx)(n.strong,{children:\"Workaround\"}),': To fix the problem, we painstakingly bent all the ic legs to the other side to \"mirror\" them...']}),`\n`,(0,e.jsxs)(n.li,{children:[(0,e.jsx)(n.strong,{children:\"Future Learning\"}),\": Use two plans, where one is the mirrored version of the other, for both sides of the board\"]}),`\n`]}),`\n`,(0,e.jsxs)(n.h3,{id:\"problem-2-empty-inputs\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#problem-2-empty-inputs\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Problem 2: Empty Inputs\"]}),`\n`,(0,e.jsxs)(n.ul,{children:[`\n`,(0,e.jsx)(n.li,{children:\"Another thing that we realized too late was all the multiplexers inputs must be connected to the circuit to make them work\"}),`\n`,(0,e.jsxs)(n.li,{children:[(0,e.jsx)(n.strong,{children:\"Workaround\"}),\": We connected all empty inputs via 10k pull up resistors to ground\"]}),`\n`,(0,e.jsxs)(n.li,{children:[(0,e.jsx)(n.strong,{children:\"Future Learning\"}),\": It's better to use up as much inputs as possible\"]}),`\n`]}),`\n`,(0,e.jsxs)(n.h2,{id:\"wiring-the-controls\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#wiring-the-controls\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Wiring the controls\"]}),`\n`,(0,e.jsx)(n.p,{children:(0,e.jsx)(n.img,{src:\"./img/panelwires.png\",alt:\"panel wires\"})}),`\n`,(0,e.jsxs)(n.ul,{children:[`\n`,(0,e.jsx)(n.li,{children:\"the middle pins of each pot + one of the pins of each switch are connected to ic inputs\"}),`\n`,(0,e.jsx)(n.li,{children:\"all other pins of the switches + one of the outer pot pins are connected to 5V\"}),`\n`,(0,e.jsx)(n.li,{children:\"all remaining pins are connected to ground\"}),`\n`,(0,e.jsx)(n.li,{children:\"all the 5V pins of the switches are connected to ground with a 10k resistor\"}),`\n`,(0,e.jsxs)(n.li,{children:[\"we transformed the rotary switches to potentiometers \",(0,e.jsx)(n.a,{href:\"https://www.instructables.com/id/Arduino-Rotary-Switch-One-Analogue-Input/\",children:\"by connecting the outer pins via resistors\"})]}),`\n`]}),`\n`,(0,e.jsx)(n.p,{children:\"For the switches and the empty inputs (see Problem 2), we added the resistors directly on the board, before the plugs:\"}),`\n`,(0,e.jsx)(n.p,{children:(0,e.jsx)(n.img,{src:\"./img/boardwithresistors.png\",alt:\"board with resistors\"})}),`\n`,(0,e.jsxs)(n.ul,{children:[`\n`,(0,e.jsxs)(n.li,{children:[(0,e.jsx)(n.strong,{children:\"Future Learning\"}),\": Add the resistors directly to the 5V pin\"]}),`\n`]}),`\n`,(0,e.jsxs)(n.h2,{id:\"programming-the-arduino\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#programming-the-arduino\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Programming the Arduino\"]}),`\n`,(0,e.jsx)(n.p,{children:\"The controls can be identified like this:\"}),`\n`,(0,e.jsx)(n.pre,{className:\"language-c\",children:(0,e.jsxs)(n.code,{className:\"language-c\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"const\"}),\" \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"int\"}),\" NControls \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"44\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`,(0,e.jsx)(n.span,{className:\"token keyword\",children:\"int\"}),\" connected\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n  `,(0,e.jsx)(n.span,{className:\"token number\",children:\"184\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// polyphonic switch\"}),`\n  `,(0,e.jsx)(n.span,{className:\"token number\",children:\"185\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// volume poti\"}),`\n  `,(0,e.jsx)(n.span,{className:\"token number\",children:\"186\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// unison switch\"}),`\n  `,(0,e.jsx)(n.span,{className:\"token number\",children:\"187\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// voice detune poti\"}),`\n  `,(0,e.jsx)(n.span,{className:\"token number\",children:\"191\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// osc3 volume poti\"}),`\n  `,(0,e.jsx)(n.span,{className:\"token number\",children:\"193\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// ext volume switch\"}),`\n  `,(0,e.jsx)(n.span,{className:\"token number\",children:\"195\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// keyboard ctrl 1 switch\"}),`\n  `,(0,e.jsx)(n.span,{className:\"token number\",children:\"196\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// amp attack poti\"}),`\n  `,(0,e.jsx)(n.span,{className:\"token number\",children:\"197\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// filter mod switch\"}),`\n  `,(0,e.jsx)(n.span,{className:\"token number\",children:\"198\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// osc1 switch\"}),`\n  `,(0,e.jsx)(n.span,{className:\"token number\",children:\"201\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// osc2 tune poti\"}),`\n  `,(0,e.jsx)(n.span,{className:\"token number\",children:\"203\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// osc1 range rotary switch\"}),`\n  `,(0,e.jsx)(n.span,{className:\"token number\",children:\"204\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// noise volume poti\"}),`\n  `,(0,e.jsx)(n.span,{className:\"token number\",children:\"205\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// osc2 switch\"}),`\n  `,(0,e.jsx)(n.span,{className:\"token number\",children:\"206\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// osc3 switch\"}),`\n  `,(0,e.jsx)(n.span,{className:\"token number\",children:\"207\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// noise switch\"}),`\n  `,(0,e.jsx)(n.span,{className:\"token number\",children:\"208\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// osc2 range rotary switch\"}),`\n  `,(0,e.jsx)(n.span,{className:\"token number\",children:\"211\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// vcf cutoff poti\"}),`\n  `,(0,e.jsx)(n.span,{className:\"token number\",children:\"213\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// vcf decay poti\"}),`\n  `,(0,e.jsx)(n.span,{className:\"token number\",children:\"214\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// osc2 vol poti\"}),`\n  `,(0,e.jsx)(n.span,{className:\"token number\",children:\"215\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// osc1 vol poti\"}),`\n  `,(0,e.jsx)(n.span,{className:\"token number\",children:\"216\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// osc2 waveform rotary switch\"}),`\n  `,(0,e.jsx)(n.span,{className:\"token number\",children:\"217\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// osc3 waveform rotary switch\"}),`\n  `,(0,e.jsx)(n.span,{className:\"token number\",children:\"218\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// vcf emphasis poti\"}),`\n  `,(0,e.jsx)(n.span,{className:\"token number\",children:\"221\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// external volume poti\"}),`\n  `,(0,e.jsx)(n.span,{className:\"token number\",children:\"223\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// keyboard ctrl 2 switch\"}),`\n  `,(0,e.jsx)(n.span,{className:\"token number\",children:\"224\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// osc1 frequency sync switch\"}),`\n  `,(0,e.jsx)(n.span,{className:\"token number\",children:\"225\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// osc3 tune poti\"}),`\n  `,(0,e.jsx)(n.span,{className:\"token number\",children:\"226\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// osc1 waveform rotary switch\"}),`\n  `,(0,e.jsx)(n.span,{className:\"token number\",children:\"227\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// osc3 range rotary switch\"}),`\n  `,(0,e.jsx)(n.span,{className:\"token number\",children:\"228\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// white/pink switch\"}),`\n  `,(0,e.jsx)(n.span,{className:\"token number\",children:\"231\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// effect 2 switch\"}),`\n  `,(0,e.jsx)(n.span,{className:\"token number\",children:\"232\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// effect 1 switch\"}),`\n  `,(0,e.jsx)(n.span,{className:\"token number\",children:\"233\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// osc2 ctrl switch\"}),`\n  `,(0,e.jsx)(n.span,{className:\"token number\",children:\"234\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// master tune poti\"}),`\n  `,(0,e.jsx)(n.span,{className:\"token number\",children:\"235\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// osc modulation switch\"}),`\n  `,(0,e.jsx)(n.span,{className:\"token number\",children:\"236\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// glide poti\"}),`\n  `,(0,e.jsx)(n.span,{className:\"token number\",children:\"237\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// mod mix poti\"}),`\n  `,(0,e.jsx)(n.span,{className:\"token number\",children:\"238\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// osc3 ctrl switch\"}),`\n  `,(0,e.jsx)(n.span,{className:\"token number\",children:\"274\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// vcf sustain poti\"}),`\n  `,(0,e.jsx)(n.span,{className:\"token number\",children:\"276\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// vcf contour poti\"}),`\n  `,(0,e.jsx)(n.span,{className:\"token number\",children:\"277\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// amp sustain poti\"}),`\n  `,(0,e.jsx)(n.span,{className:\"token number\",children:\"275\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// amp decay poti\"}),`\n  `,(0,e.jsx)(n.span,{className:\"token number\",children:\"194\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// vcf attack poti\"}),`\n`,(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`]})}),`\n`,(0,e.jsxs)(n.ul,{children:[`\n`,(0,e.jsx)(n.li,{children:\"The first two digits are the analog input of the ic (a0 - a5 = 18 - 23, a9 = 27)\"}),`\n`,(0,e.jsx)(n.li,{children:\"The third digit is where the control is connected to the ic (1-8)\"}),`\n`]}),`\n`,(0,e.jsx)(n.p,{children:\"For easier access, we can seperate the two numbers into two arrays:\"}),`\n`,(0,e.jsx)(n.pre,{className:\"language-c\",children:(0,e.jsxs)(n.code,{className:\"language-c\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"int\"}),\" analogInput\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),\"NControls\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// holds aX for every index\"}),`\n`,(0,e.jsx)(n.span,{className:\"token keyword\",children:\"int\"}),\" selectByte\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),\"NControls\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// holds select byte for every index (controls ic)\"}),`\n`,(0,e.jsx)(n.span,{className:\"token keyword\",children:\"void\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"setup\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n  `,(0,e.jsx)(n.span,{className:\"token keyword\",children:\"for\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"byte i \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),\" i \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003c\"}),\" NControls\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),\" i\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"++\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n    analogInput`,(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),\"i\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"floor\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"connected\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),\"i\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"/\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"10\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n    selectByte`,(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),\"i\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" connected\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),\"i\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"%\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"10\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n  `,(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`,(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]})}),`\n`,(0,e.jsx)(n.p,{children:\"In the loop function, we can now read all the voltages:\"}),`\n`,(0,e.jsx)(n.pre,{className:\"language-c\",children:(0,e.jsxs)(n.code,{className:\"language-c\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"void\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"loop\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n  `,(0,e.jsx)(n.span,{className:\"token keyword\",children:\"for\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"byte i \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),\" i \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003c\"}),\" NControls\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),\" i\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"++\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// loop through all connected controls\"}),`\n    `,(0,e.jsx)(n.span,{className:\"token comment\",children:\"// select correct byte for current control\"}),`\n    `,(0,e.jsx)(n.span,{className:\"token function\",children:\"digitalWrite\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"10\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"bitRead\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"selectByte\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),\"i\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n    `,(0,e.jsx)(n.span,{className:\"token function\",children:\"digitalWrite\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"11\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"bitRead\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"selectByte\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),\"i\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"1\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n    `,(0,e.jsx)(n.span,{className:\"token function\",children:\"digitalWrite\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"12\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"bitRead\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"selectByte\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),\"i\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"2\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n    `,(0,e.jsx)(n.span,{className:\"token keyword\",children:\"int\"}),\" voltage \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"analogRead\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"analogInput\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),\"i\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// 0-1023\"}),`\n    `,(0,e.jsx)(n.span,{className:\"token function\",children:\"voltageToMidi\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"voltage\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" i\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n  `,(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`,(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]})}),`\n`,(0,e.jsx)(n.p,{children:\"Now we can transform the raw voltage value to MIDI messages:\"}),`\n`,(0,e.jsx)(n.pre,{className:\"language-c\",children:(0,e.jsxs)(n.code,{className:\"language-c\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"int\"}),\" midiCh \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"9\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`,(0,e.jsx)(n.span,{className:\"token keyword\",children:\"int\"}),\" cc \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"1\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`,(0,e.jsx)(n.span,{className:\"token keyword\",children:\"int\"}),\" voltageChangeThreshold \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"8\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`,(0,e.jsx)(n.span,{className:\"token keyword\",children:\"int\"}),\" TIMEOUT \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"300\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`,(0,e.jsx)(n.span,{className:\"token keyword\",children:\"unsigned\"}),\" \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"long\"}),\" PTime\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),\"NControls\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// previous time the voltage changed (more than threshold)\"}),`\n`,(0,e.jsx)(n.span,{className:\"token keyword\",children:\"int\"}),\" midiPState\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),\"NControls\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// previous sent midi value for control i\"}),`\n`,(0,e.jsx)(n.span,{className:\"token keyword\",children:\"int\"}),\" voltagePState\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),\"NControls\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// voltage of control i at last midi send\"}),`\n\n`,(0,e.jsx)(n.span,{className:\"token keyword\",children:\"void\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"voltageToMidi\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token keyword\",children:\"int\"}),\" voltage\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"int\"}),\" i\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n  `,(0,e.jsx)(n.span,{className:\"token keyword\",children:\"if\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"abs\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"voltage\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"-\"}),\"voltagePState\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),\"i\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003e\"}),\" voltageChangeThreshold\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n    PTime`,(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),\"i\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"millis\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n  `,(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n  `,(0,e.jsx)(n.span,{className:\"token keyword\",children:\"if\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"millis\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"-\"}),\" PTime\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),\"i\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003c\"}),\" TIMEOUT\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n    `,(0,e.jsx)(n.span,{className:\"token comment\",children:'// here the voltage changed significantly and \"stayed there\" for more than 300 ms'}),`\n    `,(0,e.jsx)(n.span,{className:\"token keyword\",children:\"int\"}),\" midiValue\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n    `,(0,e.jsx)(n.span,{className:\"token keyword\",children:\"if\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"isInverted\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"connected\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),\"i\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n      midiValue `,(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"map\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"voltage\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"1023\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"127\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// flipped last 2 numbers to invert\"}),`\n    `,(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),\" \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"else\"}),\" \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"if\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"connected\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),\"i\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"==\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"227\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n      midiValue `,(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"rotaryMidi\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"voltage\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"6\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"7\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"1\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n    `,(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),\" \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"else\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n      midiValue `,(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"map\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"voltage\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"1023\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"127\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n    `,(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n    `,(0,e.jsx)(n.span,{className:\"token comment\",children:\"// only send midi if it changes (0-127)\"}),`\n    `,(0,e.jsx)(n.span,{className:\"token keyword\",children:\"if\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"midiPState\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),\"i\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"!=\"}),\" midiValue\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n      `,(0,e.jsx)(n.span,{className:\"token function\",children:\"controlChange\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"midiCh\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" cc\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),\"i\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" midiValue\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// send midi\"}),`\n      MidiUSB`,(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"flush\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// force send midi immediately\"}),`\n      voltagePState`,(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),\"i\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" voltage\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// remember last voltage where midi was sent\"}),`\n      midiPState`,(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),\"i\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" midiValue\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// update last sent midi\"}),`\n    `,(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n  `,(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`,(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]})}),`\n`,(0,e.jsxs)(n.ul,{children:[`\n`,(0,e.jsx)(n.li,{children:\"to compensate for voltage jitter, we ignore voltage changes that are lower than a threshold of 8\"}),`\n`,(0,e.jsx)(n.li,{children:\"if the voltage change is above the the theshold, the time is remembered\"}),`\n`,(0,e.jsx)(n.li,{children:\"for 300ms after a significant voltage change, the voltage is mapped to a midi value (0-127)\"}),`\n`,(0,e.jsxs)(n.li,{children:[\"if the calculated midi value is different from the last, the value is sent out, using \",(0,e.jsx)(n.a,{href:\"https://www.arduino.cc/en/Reference/MIDIUSB\",children:\"MIDIUSB lib\"})]}),`\n`,(0,e.jsx)(n.li,{children:\"isInverted inverts the mapping for controls with inverted voltages (depends on wiring of 5v and ground)\"}),`\n`,(0,e.jsx)(n.li,{children:\"rotaryMidi maps the 6 step rotary switch to the target 7 step midi value of osc3 range (ignoring the first step)\"}),`\n`]}),`\n`,(0,e.jsx)(\"a\",{href:\"https://gist.github.com/felixroos/929a8d9c303748179c6bca835e6a16ab\",target:\"_blank\",children:(0,e.jsx)(n.p,{children:\"show complete code\"})}),`\n`,(0,e.jsxs)(n.h2,{id:\"conclusion\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#conclusion\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Conclusion\"]}),`\n`,(0,e.jsx)(n.p,{children:\"After 4 days of soldering, and learning a lot about electronics, the basic controller was finished. I also built a prototype case:\"}),`\n`,(0,e.jsx)(n.p,{children:(0,e.jsx)(n.img,{src:\"./img/caseprototype.jpg\",alt:\"case\"})}),`\n`,(0,e.jsx)(n.p,{children:\"Huge thanks goes out\"}),`\n`,(0,e.jsxs)(n.ul,{children:[`\n`,(0,e.jsx)(n.li,{children:(0,e.jsx)(n.a,{href:\"https://goetzmd.de/category/diy/diy-midi-controller\",children:\"!! Goetz M\\xFCller D\\xFCrholt for his DIY Midi Controller Series\"})}),`\n`,(0,e.jsx)(n.li,{children:(0,e.jsx)(n.a,{href:\"https://www.musiconerd.com/single-post/arduino-pro-micro-as-a-usb-midi-device\",children:\"Gustavo Silveira for the mapping idea\"})}),`\n`,(0,e.jsx)(n.li,{children:(0,e.jsx)(n.a,{href:\"https://www.instructables.com/id/Arduino-Rotary-Switch-One-Analogue-Input/\",children:\"Mr Fid for the rotary switch idea\"})}),`\n`]}),`\n`,(0,e.jsx)(n.p,{children:\"I already know that this was not the last MIDI controller to build for myself. Next time, I will try to build a controller for the Prophet V (maybe also including keys).\"}),`\n`,(0,e.jsxs)(n.h3,{id:\"tbd\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#tbd\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"TBD\"]}),`\n`,(0,e.jsxs)(n.ul,{children:[`\n`,(0,e.jsx)(n.li,{children:\"build proper case\"}),`\n`,(0,e.jsx)(n.li,{children:\"add labels\"}),`\n`,(0,e.jsx)(n.li,{children:\"minor midi mapping issues\"}),`\n`]})]});return s?(0,e.jsx)(s,Object.assign({},a,{children:t})):t}var f=b;return y;})();\n;return Component.default;"},"__N_SSG":true},"page":"/[slug]","query":{"slug":"midimoog"},"buildId":"rm7EPdF-9_FvWqPzmBFFD","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>