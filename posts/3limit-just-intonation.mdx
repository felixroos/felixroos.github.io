---
title: 3 Limit Just Intonation
date: '2020-04-26'
tags: ['tuning', 'music theory']
description: 'After building a foundation of understanding pure intervals in the last post, we will now look at different ways of building tuning systems with them.'
image: ./img/3limit-chroma.png

---

import ConnectedCircle from '../components/common/ConnectedCircle.tsx';
import TuningCircle from '../components/tuning/TuningCircle.tsx';
import Monochord from '../components/tuning/Monochord.tsx';
import { InlineMath, BlockMath } from 'react-katex';
import { State } from 'react-powerplug';
import Slider from '@material-ui/core/Slider';
import Select from '@material-ui/core/Select';
import Fraction from 'fraction.js';
import canUseDOM from '../components/canUseDOM.ts';
import { cents, generate, frequencyColor, pythagoreanComma } from '../components/tuning/tuning.ts';
import * as Tone from 'tone';
import { harp } from '../components/common/harp.ts';

After building a foundation of understanding pure intervals in the last post, we will now look at different ways of building tuning systems with them.
This post focuses on the most simple interval: fifths.

## Stacking Fifths

In the last post, we were stacking octave reduced fifths on top of each other:

<div className="flex mb-2">
  <Monochord value={1} invert={true} base={220} />
  <InlineMath>{`\\frac{3}{2}^{0}*2^0`}</InlineMath>
</div>
<div className="flex mb-2">
  <Monochord value={8 / 9} invert={true} base={220} />
  <InlineMath>{`\\frac{3}{2}^{2}*2^{-1}`}</InlineMath>
</div>
<div className="flex mb-2">
  <Monochord value={64 / 81} invert={true} base={220} />
  <InlineMath>{`\\frac{3}{2}^{4}*2^{-2}`}</InlineMath>
</div>
<div className="flex mb-2">
  <Monochord value={2 / 3} invert={true} base={220} />
  <InlineMath>{`\\frac{3}{2}^{1}*2^0`}</InlineMath>
</div>
<div className="flex mb-2">
  <Monochord value={16 / 27} invert={true} base={220} />
  <InlineMath>{`\\frac{3}{2}^{3} * 2^{-1}`}</InlineMath>
</div>

Note that the ratios are frequency ratios instead of length ratios (as they were in the last post).

**Explanation**:

- The intervals are generated by powers of 3/2, which means we are stacking fifths ontop of each other
- The multiplication by powers of 2 moves the ratios between 1 and 2:

$$1 \leq \frac{3}{2}^{a} * 2^{b} \geq 2$$

### Simplification

To clean up the calculation, we could pull out the /2 and move it to the powers of 2:

$$\frac{3}{2}^{a} * 2^{b} = 3^{a} * 2^{b-a}$$

To reflect that in our example, we can apply the right side of the equation above:

<div className="flex mb-2">
  <Monochord value={1} invert={true} base={220} />
  <InlineMath>{`3^0*2^{0}`}</InlineMath>
</div>
<div className="flex mb-2">
  <Monochord value={8 / 9} invert={true} base={220} />
  <InlineMath>{`3^2*2^{-3}`}</InlineMath>
</div>
<div className="flex mb-2">
  <Monochord value={64 / 81} invert={true} base={220} />
  <InlineMath>{`3^4*2^{-6}`}</InlineMath>
</div>
<div className="flex mb-2">
  <Monochord value={2 / 3} invert={true} base={220} />
  <InlineMath>{`3^1*2^{-1}`}</InlineMath>
</div>
<div className="flex mb-2">
  <Monochord value={16 / 27} invert={true} base={220} />
  <InlineMath>{`3^3 * 2^{-4}`}</InlineMath>
</div>

## N-Limit

The above simplification aimed to pave the way for a more abstract understanding of stacking numbers in a tuning system.
This is where N-Limit Tuning comes in. N-Limit Tuning generates ratios by multiplying powers of natural numbers up to N.

For example, 3 Limit ratios can be calculated with $$R_{3} = 2^{a} * 3^{b}$$

And 5 Limit ratios with $$R_{5} = 2^{a} * 3^{b} * 5^{c}$$

**What about the 4?**

We can skip the 4 because it is not a prime number, thus factorizable with lower primes.

### Why are we doing this again?

Let's forget all the mathematics and just focus on why this is even a good idea.
What does it mean to power 3 (or any other prime number)? To understand it, we can think of the number 3 as the 3rd partial in the harmonic series, which is in musical terms an octave + a fifth.
If we multiply this 3 with any fundamental frequency, what we get is the frequency that is an octave and a fifth higher. If we multiply that new frequency again with 3, we get one octave + a fifth more and so on.

So essentially, we are building harmonics of harmonics. This will lead to pitches that have many harmonics in common, which results in a harmonic relationship between them, thats what we want.

Of course those frequencies will quickly get really high, which is why we utilize octave reduction.

## 3 Limit Tuning

Enough of the theoretical blabla, let's make some "music":

<State initial={{ power: 0 }}>
  {({ state, setState }) => {
    function calculate(power) {
      const factor = Math.pow(3, power);
      const exp = Math.ceil(Math.log(1 / factor) / Math.log(2));
      const value = Math.pow(2, exp) * factor;
      const [top, bottom] = new Fraction(value).toFraction().split('/');
      return { factor, exp, value, top, bottom };
    }
    const { factor, exp, value, top, bottom } = calculate(state.power);
    return (
      <div>
        <InlineMath>{`b = ${state.power}`}</InlineMath>
        <br />
        <Slider
          min={-7}
          max={7}
          marks
          track={false}
          value={state.power}
          onMouseDown={() => harp.triggerAttackRelease(value * 440, 1)}
          onChange={(e, v) => {
            if (v !== state.power) {
              const { value } = calculate(v);
              harp.triggerAttackRelease(value * 440, 1);
              setState({ power: v });
            }
          }}
        />{' '}
        <br />
        <InlineMath>{`R_f = 2^{a} * 3^{b} = 2^{${exp}} * 3^{${state.power}} = \\frac{${top}}{${bottom || 1}}`}</InlineMath>
        <br />
        <InlineMath>{`a = \\lceil\\log_2 3^{-b}\\rceil = \\lceil\\log_2 {3^{${state.power * -1}}}\\rceil = ${exp}`}</InlineMath>
        <br />
        <br />
        <Monochord value={1 / value} amplitude={1} invert={false} base={440} />
        <InlineMath>{`R_l = \\frac{1}{R_f} = \\frac{${bottom || 1}}{${top}}`}</InlineMath>
      </div>
    );
  }}
</State>

- Here we are generating ratios with a limit of 3, which is why why can call it 3 limit tuning.
- The slider controls the exponent of the 3 (= _b_), while the exponent of the 2 (= _a_) is calculated automatically to stay in one octave
- You can ignore the formula for _a_ if you like, but if you are curious, you can see the derivation below (automatic octave reduction)

### Tuning Circle

Now we can generate a whole tuning system, by picking a range of ratios. We can visualize their position in the octave in a circular fashion:

<State
  initial={{
    toggle: false,
    interval: 1,
    focus: undefined,
    pitches: 5,
    rotate: 0,
    preset: -1,
    // sort: false
  }}
>
  {({ state, setState }) => {
    const [from, to] = [state.rotate, state.rotate + state.pitches - 1];
    const ratios = generate(3, state.pitches + state.rotate, state.pitches, 2);
    const range = [-28, 28];
    const base = 440;
    const selectedPreset = state.preset >= 0 ? state.preset : undefined;
    const presets = [
      [0, 5, 'Major Pentatonic'],
      [-3, 5, 'Minor Pentatonic'],
      [0, 7, 'Lydian'],
      [-1, 7, 'Ionian'],
      [-2, 7, 'Mixolydian'],
      [-3, 7, 'Dorian'],
      [-4, 7, 'Aeolian'],
      [-5, 7, 'Phrygian'],
      [-6, 7, 'Locrian'],
      [-5, 12, '12 Notes centered'],
      [-26, 53, '53 Notes centered'],
    ];
    return (
      <div>
        <InlineMath>{`3^{${from}} - 3^{${to}}`}</InlineMath>
        <br />
        <ConnectedCircle
          r={100}
          nodeRadius={20}
          nodes={ratios.map(({ ratio, power }, id) => ({
            id: power,
            label: power,
            value: cents(ratio) / 1200,
            ratio,
            distance: 140,
            fill: frequencyColor(base * ratio),
          }))}
          links={[]}
          onClick={({ node }) => {
            if (node) {
              harp.triggerAttackRelease(node.ratio * base, 1);
            }
          }}
        />
        <br />
        <select
          value={selectedPreset}
          onChange={(e) => {
            const [rotate, pitches] = presets[e.target.value];
            setState({ rotate, pitches });
          }}
        >
          {presets.map(([rotate, pitches, title], i) => (
            <option key={i} value={i}>
              {title}
            </option>
          ))}
        </select>
        <br />
        {state.pitches} pitch{state.pitches !== 1 ? 'es' : ''}
        <br />
        <Slider
          marks
          track={false}
          min={2}
          max={60}
          value={state.pitches}
          onChange={(e, v) => v !== state.pitches && setState({ pitches: v })}
        />
        <br />
        rotate by {state.rotate} power{Math.abs(state.rotate) !== 1 ? 's' : ''}
        <br />
        <Slider
          marks
          track={false}
          min={-state.pitches + 1}
          max={0}
          value={state.rotate}
          onChange={(e, v) => v !== state.rotate && setState({ rotate: v })}
        />
        <h3>Tuning Table</h3>
        <p>Let's look at the underlying data of the graphic above in a so called Tuning Table:</p>
        {/* <label style={{float:'right'}}>
          <input type="checkbox"
            checked={state.sort}
            onChange={(e) => setState({ sort: e.target.checked })}
          />
          Sort
        </label> */}
        <table>
          <tbody>
            <tr>
              <th>position</th>
              <th>powers</th>
              <th>ratio</th>
              <th>cents</th>
              <th>listen</th>
            </tr>
            {ratios.map(({ ratio, power }, i) => {
              const factor = Math.pow(3, power);
              const [top, bottom] = new Fraction(ratio).toFraction().split('/');
              const exp = Math.ceil(Math.log(1 / factor) / Math.log(2));
              return (
                <tr key={i}>
                  <td>{i}</td>
                  <td>
                    <InlineMath key={i}>{`3^{${power}} * 2^{${exp}}`}</InlineMath>
                  </td>
                  <td>
                    <InlineMath key={i}>{`\\frac{${top}}{${bottom || 1}}`}</InlineMath>
                  </td>
                  <td>{Math.round(cents(ratio))}</td>
                  <td>
                    <button onClick={() => harp.triggerAttackRelease(ratio * base, 1)}>Play</button>
                  </td>
                </tr>
              );
            })}
          </tbody>
        </table>
      </div>
    );
  }}
</State>

The tuning above is mostly known in the west from pythagoras, also called the pythagorean tuning.
Although pythagoras was not the first who invented that type of tuning, as we know now, see Shí-èr-lǜ for an earlier variant.

**Observations**

- At 12 pitches, the fractions seem to reach a point of saturation, where all pitches are more or less equidistant
- The 13th pitch is really close to the first
- The next "point of saturation" is not reached until 53 pitches are generated
- By rotation, we can generate all the greek modes + pentatonics
- Rotating left will darken the scale (more subharmonic partials), while rotating right will brighten the scale (more harmonic partials)

Here we see the main reason for why western music uses a 12 note tuning system!

## The Pythagorean Comma

This 12 note system is only almost perfect. The problem: if we stack another fifth ontop of the 12th one, the resulting pitch is a little bit too high than it should be.
The system would be perfect if the 13ths fifth would end up being the fundamental ratio again. But this is mathematically impossible:

$$
2^{-19} * 3^{12} = \frac{531441}{524288} \approx 1.0136432 \neq 1
$$

or put differently, using fifths:

$$
{(\frac{3}{2})}^{12} = \frac{531441}{4096} \approx 129.7463 \neq 2^7 = 128
$$

**Explanation**: If we stack 12 fifths, we dont land exactly 7 octaves higher, but slightly off.
If we divide those 7 octaves to get the difference, we come to the same result as above:

$$
R_{pc} = {(\frac{3}{2})}^{12} : 2^7 = \frac{531441}{524288} \approx 1.0136432
$$

This little "error" is called the pythagorean comma.

We could try to correct that comma, by subtracting 1/12 of it from each consecutive fifth. But this will be a topic for another post,
as this is a step away from Just Intonation to Equal Temperment.

## Automatic Octave reduction

In the calculations above, the exponent of the factor 2 was used to move the resulting ratio between 1 and 2 (= inside one octave).

#### Recursive Solution

An easy and expressive way to solve this is using a recursive function:

```js
export function clamp(ratio) {
  if (ratio > 2) {
    return clamp(ratio / 2);
  }
  if (ratio < 1) {
    return clamp(ratio * 2);
  }
  return ratio;
}
```

Here, we are just dividing or multiplying by 2 until the number sits between 1 and 2.

### Mathematical Solution

To make your inner mathematician proud, lets now try an algebraic "proof" and find a function that applies octave reduction.

The goal of octave reduction is to multiply a certain ratio R with powers of 2, until it is between 1 and 2.
With that in mind, we can come up with a range of numbers that can be used as exponents of 2:

$$
1 \leq R * 2^{x} \geq 2
$$

$$
\frac{1}{R} \leq 2^{x} \geq \frac{2}{R}
$$

$$
\log_2 ({\frac{1}{R}}) \leq x \geq \log_2 ({\frac{2}{R}})
$$

So x is inside:

$$
[\log_2 ({\frac{1}{R}}), \log_2 ({\frac{2}{R}})]
$$

Example:

$$
R = 3^{4}
$$

$$
[\log_2 ({\frac{1}{3^{4}}}), \log_2 ({\frac{2}{3^{4}}})] = [-6.34, -5.34]
$$

As we want a whole number exponent, we have -6 as the single solution.

#### Simplification

As powers of 3 grow faster than powers of 2, there will always be just one solution inside the interval.
So for all bases above 2 we can simplify this by rounding up the first / rounding down the second interval bound. As the first bound is more compact, our solution will be:

$$
\lceil\log_2 ({R^{-1}})\rceil
$$

(_Those brackets mean rounding up_)

#### Disclaimer

As I am not a real mathematician, this proof may lack some formal finesse, but the point should be clear.

### More

Now that's it for today. We will look at 5-limit tuning and equal temperament in the next posts.
Here are some more or less related links:

- https://en.xen.wiki/w/Just_intonation
- https://en.wikipedia.org/wiki/Just_intonation
- https://www.youtube.com/watch?v=cyW5z-M2yzw
- https://www.youtube.com/watch?v=IT9CPoe5LnM
- https://www.youtube.com/watch?v=1Hqm0dYKUx4
- http://www.garygarrett.me/?page_id=1922
